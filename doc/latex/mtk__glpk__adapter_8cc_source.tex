\hypertarget{mtk__glpk__adapter_8cc_source}{\section{mtk\+\_\+glpk\+\_\+adapter.\+cc}
\label{mtk__glpk__adapter_8cc_source}\index{src/mtk\+\_\+glpk\+\_\+adapter.\+cc@{src/mtk\+\_\+glpk\+\_\+adapter.\+cc}}
}

\begin{DoxyCode}
00001 
00020 \textcolor{comment}{/*}
00021 \textcolor{comment}{Copyright (C) 2015, Computational Science Research Center, San Diego State}
00022 \textcolor{comment}{University. All rights reserved.}
00023 \textcolor{comment}{}
00024 \textcolor{comment}{Redistribution and use in source and binary forms, with or without modification,}
00025 \textcolor{comment}{are permitted provided that the following conditions are met:}
00026 \textcolor{comment}{}
00027 \textcolor{comment}{1. Modifications to source code should be reported to: esanchez@mail.sdsu.edu}
00028 \textcolor{comment}{and a copy of the modified files should be reported once modifications are}
00029 \textcolor{comment}{completed, unless these modifications are made through the project's GitHub}
00030 \textcolor{comment}{page: http://www.csrc.sdsu.edu/mtk. Documentation related to said modifications}
00031 \textcolor{comment}{should be developed and included in any deliverable.}
00032 \textcolor{comment}{}
00033 \textcolor{comment}{2. Redistributions of source code must be done through direct}
00034 \textcolor{comment}{downloads from the project's GitHub page: http://www.csrc.sdsu.edu/mtk}
00035 \textcolor{comment}{}
00036 \textcolor{comment}{3. Redistributions in binary form must reproduce the above copyright notice,}
00037 \textcolor{comment}{this list of conditions and the following disclaimer in the documentation and/or}
00038 \textcolor{comment}{other materials provided with the distribution.}
00039 \textcolor{comment}{}
00040 \textcolor{comment}{4. Usage of the binary form on proprietary applications shall require explicit}
00041 \textcolor{comment}{prior written permission from the the copyright holders, and due credit should}
00042 \textcolor{comment}{be given to the copyright holders.}
00043 \textcolor{comment}{}
00044 \textcolor{comment}{5. Neither the name of the copyright holder nor the names of its contributors}
00045 \textcolor{comment}{may be used to endorse or promote products derived from this software without}
00046 \textcolor{comment}{specific prior written permission.}
00047 \textcolor{comment}{}
00048 \textcolor{comment}{The copyright holders provide no reassurances that the source code provided does}
00049 \textcolor{comment}{not infringe any patent, copyright, or any other intellectual property rights of}
00050 \textcolor{comment}{third parties. The copyright holders disclaim any liability to any recipient for}
00051 \textcolor{comment}{claims brought against recipient by any third party for infringement of that}
00052 \textcolor{comment}{parties intellectual property rights.}
00053 \textcolor{comment}{}
00054 \textcolor{comment}{THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND}
00055 \textcolor{comment}{ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED}
00056 \textcolor{comment}{WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE}
00057 \textcolor{comment}{DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR}
00058 \textcolor{comment}{ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES}
00059 \textcolor{comment}{(INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;}
00060 \textcolor{comment}{LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON}
00061 \textcolor{comment}{ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT}
00062 \textcolor{comment}{(INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS}
00063 \textcolor{comment}{SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.}
00064 \textcolor{comment}{*/}
00065 
00066 \textcolor{preprocessor}{#include <cmath>}
00067 \textcolor{preprocessor}{#include <cstring>}
00068 
00069 \textcolor{preprocessor}{#include <iostream>}
00070 \textcolor{preprocessor}{#include <iomanip>}
00071 \textcolor{preprocessor}{#include <limits>}
00072 
00073 \textcolor{preprocessor}{#include "\hyperlink{mtk__roots_8h}{mtk\_roots.h}"}
00074 \textcolor{preprocessor}{#include "\hyperlink{mtk__blas__adapter_8h}{mtk\_blas\_adapter.h}"}
00075 \textcolor{preprocessor}{#include "\hyperlink{mtk__glpk__adapter_8h}{mtk\_glpk\_adapter.h}"}
00076 
\hypertarget{mtk__glpk__adapter_8cc_source_l00077}{}\hyperlink{classmtk_1_1GLPKAdapter_a834480aca83e3c0d09fdab7fdb7e8a3f}{00077} \hyperlink{group__c01-roots_gac080bbbf5cbb5502c9f00405f894857d}{mtk::Real} \hyperlink{classmtk_1_1GLPKAdapter_a834480aca83e3c0d09fdab7fdb7e8a3f}{mtk::GLPKAdapter::SolveSimplexAndCompare}(
      \hyperlink{group__c01-roots_gac080bbbf5cbb5502c9f00405f894857d}{mtk::Real} *A,
00078                                                    \textcolor{keywordtype}{int} nrows,
00079                                                    \textcolor{keywordtype}{int} ncols,
00080                                                    \textcolor{keywordtype}{int} kk,
00081                                                    \hyperlink{group__c01-roots_gac080bbbf5cbb5502c9f00405f894857d}{mtk::Real} *hh,
00082                                                    \hyperlink{group__c01-roots_gac080bbbf5cbb5502c9f00405f894857d}{mtk::Real} *qq,
00083                                                    \textcolor{keywordtype}{int} robjective,
00084                                                    \hyperlink{group__c01-roots_gac080bbbf5cbb5502c9f00405f894857d}{mtk::Real} mimetic\_threshold,
00085                                                    \textcolor{keywordtype}{int} copy) \{
00086 
00087 \textcolor{preprocessor}{  #if MTK\_DEBUG\_LEVEL > 0}
00088   \textcolor{keywordtype}{char} mps\_file\_name[18]; \textcolor{comment}{// File name for the MPS files.}
00089 \textcolor{preprocessor}{  #endif}
00090   \textcolor{keywordtype}{char} rname[5];          \textcolor{comment}{// Row name.}
00091   \textcolor{keywordtype}{char} cname[5];          \textcolor{comment}{// Column name.}
00092 
00093   glp\_prob *lp; \textcolor{comment}{// Linear programming problem.}
00094 
00095   \textcolor{keywordtype}{int} *ia;  \textcolor{comment}{// Array for the problem.}
00096   \textcolor{keywordtype}{int} *ja;  \textcolor{comment}{// Array for the problem.}
00097 
00098   \textcolor{keywordtype}{int} problem\_size; \textcolor{comment}{// Size of the problem.}
00099   \textcolor{keywordtype}{int} lp\_nrows;     \textcolor{comment}{// Number of rows.}
00100   \textcolor{keywordtype}{int} lp\_ncols;     \textcolor{comment}{// Number of columns.}
00101   \textcolor{keywordtype}{int} matsize;      \textcolor{comment}{// Size of the matrix.}
00102   \textcolor{keywordtype}{int} glp\_index\{1\}; \textcolor{comment}{// Index of the objective function.}
00103   \textcolor{keywordtype}{int} ii;           \textcolor{comment}{// Iterator.}
00104   \textcolor{keywordtype}{int} jj;           \textcolor{comment}{// Iterator.}
00105 
00106   \hyperlink{group__c01-roots_gac080bbbf5cbb5502c9f00405f894857d}{mtk::Real} *ar;            \textcolor{comment}{// Array for the problem.}
00107   \hyperlink{group__c01-roots_gac080bbbf5cbb5502c9f00405f894857d}{mtk::Real} *objective;     \textcolor{comment}{// Array containing the objective function.}
00108   \hyperlink{group__c01-roots_gac080bbbf5cbb5502c9f00405f894857d}{mtk::Real} *rhs;           \textcolor{comment}{// Array containing the rhs.}
00109   \hyperlink{group__c01-roots_gac080bbbf5cbb5502c9f00405f894857d}{mtk::Real} *err;           \textcolor{comment}{// Array of errors.}
00110 
00111   \hyperlink{group__c01-roots_gac080bbbf5cbb5502c9f00405f894857d}{mtk::Real} x1;             \textcolor{comment}{// Norm-2 of the error.}
00112 
00113 \textcolor{preprocessor}{  #if MTK\_DEBUG\_LEVEL > 0}
00114   \hyperlink{group__c01-roots_gac080bbbf5cbb5502c9f00405f894857d}{mtk::Real} obj\_value;      \textcolor{comment}{// Value of the objective function.}
00115 \textcolor{preprocessor}{  #endif}
00116 
00117   lp\_nrows = kk;
00118   lp\_ncols = kk;
00119 
00120   matsize = lp\_nrows*lp\_ncols;
00121 
00123 
00125   problem\_size = lp\_nrows*lp\_ncols + 1;
00126 
00127   \textcolor{keywordflow}{try} \{
00128     ia = \textcolor{keyword}{new} \textcolor{keywordtype}{int}[problem\_size];
00129   \} \textcolor{keywordflow}{catch} (std::bad\_alloc &memory\_allocation\_exception) \{
00130     std::cerr << \textcolor{stringliteral}{"Memory allocation exception on line "} << \_\_LINE\_\_ - 3 <<
00131       std::endl;
00132     std::cerr << memory\_allocation\_exception.what() << std::endl;
00133   \}
00134   memset(ia, 0, \textcolor{keyword}{sizeof}(ia[0])*problem\_size);
00135 
00136   \textcolor{keywordflow}{try} \{
00137     ja = \textcolor{keyword}{new} \textcolor{keywordtype}{int}[problem\_size];
00138   \} \textcolor{keywordflow}{catch} (std::bad\_alloc &memory\_allocation\_exception) \{
00139     std::cerr << \textcolor{stringliteral}{"Memory allocation exception on line "} << \_\_LINE\_\_ - 3 <<
00140       std::endl;
00141     std::cerr << memory\_allocation\_exception.what() << std::endl;
00142   \}
00143   memset(ja, 0, \textcolor{keyword}{sizeof}(ja[0])*problem\_size);
00144 
00145   \textcolor{keywordflow}{try} \{
00146     ar = \textcolor{keyword}{new} \hyperlink{group__c01-roots_gac080bbbf5cbb5502c9f00405f894857d}{mtk::Real}[problem\_size];
00147   \} \textcolor{keywordflow}{catch} (std::bad\_alloc &memory\_allocation\_exception) \{
00148     std::cerr << \textcolor{stringliteral}{"Memory allocation exception on line "} << \_\_LINE\_\_ - 3 <<
00149       std::endl;
00150     std::cerr << memory\_allocation\_exception.what() << std::endl;
00151   \}
00152   memset(ar, \hyperlink{group__c01-roots_ga59a451a5fae30d59649bcda274fea271}{mtk::kZero}, \textcolor{keyword}{sizeof}(ar[0])*problem\_size);
00153 
00154   \textcolor{keywordflow}{try} \{
00155     objective = \textcolor{keyword}{new} \hyperlink{group__c01-roots_gac080bbbf5cbb5502c9f00405f894857d}{mtk::Real}[lp\_ncols + 1];
00156   \} \textcolor{keywordflow}{catch} (std::bad\_alloc &memory\_allocation\_exception) \{
00157     std::cerr << \textcolor{stringliteral}{"Memory allocation exception on line "} << \_\_LINE\_\_ - 3 <<
00158       std::endl;
00159     std::cerr << memory\_allocation\_exception.what() << std::endl;
00160   \}
00161   memset(objective, \hyperlink{group__c01-roots_ga59a451a5fae30d59649bcda274fea271}{mtk::kZero}, \textcolor{keyword}{sizeof}(objective[0])*(lp\_ncols + 1));
00162 
00163   \textcolor{keywordflow}{try} \{
00164     rhs = \textcolor{keyword}{new} \hyperlink{group__c01-roots_gac080bbbf5cbb5502c9f00405f894857d}{mtk::Real}[lp\_nrows + 1];
00165   \} \textcolor{keywordflow}{catch} (std::bad\_alloc &memory\_allocation\_exception) \{
00166     std::cerr << \textcolor{stringliteral}{"Memory allocation exception on line "} << \_\_LINE\_\_ - 3 <<
00167       std::endl;
00168     std::cerr << memory\_allocation\_exception.what() << std::endl;
00169   \}
00170   memset(rhs, \hyperlink{group__c01-roots_ga59a451a5fae30d59649bcda274fea271}{mtk::kZero}, \textcolor{keyword}{sizeof}(rhs[0])*(lp\_nrows + 1));
00171 
00172   \textcolor{keywordflow}{try} \{
00173     err = \textcolor{keyword}{new} \hyperlink{group__c01-roots_gac080bbbf5cbb5502c9f00405f894857d}{mtk::Real}[lp\_nrows];
00174   \} \textcolor{keywordflow}{catch} (std::bad\_alloc &memory\_allocation\_exception) \{
00175     std::cerr << \textcolor{stringliteral}{"Memory allocation exception on line "} << \_\_LINE\_\_ - 3 <<
00176       std::endl;
00177     std::cerr << memory\_allocation\_exception.what() << std::endl;
00178   \}
00179   memset(err, \hyperlink{group__c01-roots_ga59a451a5fae30d59649bcda274fea271}{mtk::kZero}, \textcolor{keyword}{sizeof}(err[0])*(lp\_nrows));
00180 
00181 \textcolor{preprocessor}{  #if MTK\_DEBUG\_LEVEL > 0}
00182   std::cout << \textcolor{stringliteral}{"Problem size: "} << problem\_size << std::endl;
00183   std::cout << \textcolor{stringliteral}{"lp\_nrows = "} << lp\_nrows << std::endl;
00184   std::cout << \textcolor{stringliteral}{"lp\_ncols = "} << lp\_ncols << std::endl;
00185   std::cout << std::endl;
00186 \textcolor{preprocessor}{  #endif}
00187 
00188   lp = glp\_create\_prob();
00189 
00190   glp\_set\_prob\_name (lp, \textcolor{stringliteral}{"mtk::GLPKAdapter::Simplex"});
00191 
00192   glp\_set\_obj\_dir (lp, GLP\_MIN);
00193 
00195 
00196   glp\_add\_rows(lp, lp\_nrows);
00197 
00198   \textcolor{keywordflow}{for} (ii = 1; ii <= lp\_nrows; ++ii) \{
00199     sprintf(rname, \textcolor{stringliteral}{"R%02d"},ii);
00200     glp\_set\_row\_name(lp, ii, rname);
00201   \}
00202 
00203   glp\_add\_cols(lp, lp\_ncols);
00204 
00205   \textcolor{keywordflow}{for} (ii = 1; ii <= lp\_ncols; ++ii) \{
00206     sprintf(cname, \textcolor{stringliteral}{"Q%02d"},ii);
00207     glp\_set\_col\_name (lp, ii, cname);
00208   \}
00209 
00211 
00212 \textcolor{preprocessor}{  #if MTK\_DEBUG\_LEVEL>0}
00213   std::cout << \textcolor{stringliteral}{"Using row "} << robjective + 1 << \textcolor{stringliteral}{" as objective."} << std::endl;
00214 \textcolor{preprocessor}{  #endif}
00215   \textcolor{keywordflow}{for} (jj = 0; jj < kk; ++jj) \{
00216     objective[glp\_index] = A[jj + robjective * ncols];
00217     glp\_index++;
00218   \}
00219 \textcolor{preprocessor}{  #if MTK\_DEBUG\_LEVEL >0}
00220   std::cout << std::endl;
00221 \textcolor{preprocessor}{  #endif}
00222 
00224 
00225   glp\_index = 1;
00226   rhs[0] = \hyperlink{group__c01-roots_ga59a451a5fae30d59649bcda274fea271}{mtk::kZero};
00227   \textcolor{keywordflow}{for} (ii = 0; ii <= lp\_nrows; ++ii) \{
00228     \textcolor{keywordflow}{if} (ii != robjective) \{
00229       rhs[glp\_index] = hh[ii];
00230       glp\_set\_row\_bnds(lp, glp\_index, GLP\_UP, 0.0, rhs[glp\_index]);
00231       glp\_index++;
00232     \}
00233   \}
00234 
00235 \textcolor{preprocessor}{  #if MTK\_DEBUG\_LEVEL > 0}
00236   std::cout << \textcolor{stringliteral}{"rhs ="} << std::endl;
00237   \textcolor{keywordflow}{for} (\textcolor{keyword}{auto} ii = 0; ii < lp\_nrows; ++ii) \{
00238     std::cout << std::setw(15) << rhs[ii] << std::endl;
00239   \}
00240   std::cout << std::endl;
00241 \textcolor{preprocessor}{  #endif}
00242 
00244 
00245   \textcolor{keywordflow}{for} (ii = 1; ii <= lp\_ncols; ++ii) \{
00246     glp\_set\_obj\_coef (lp, ii, objective[ii]);
00247   \}
00248 
00250 
00251   \textcolor{keywordflow}{for} (ii = 1; ii <= lp\_ncols; ++ii) \{
00252     glp\_set\_col\_bnds (lp, ii, GLP\_LO, mimetic\_threshold, 0.0);
00253   \}
00254 
00256 
00257   glp\_index = 1;
00258   \textcolor{keywordflow}{for} (ii = 0; ii <= kk; ++ii) \{
00259     \textcolor{keywordflow}{for} (jj = 0; jj < kk; ++jj) \{
00260       \textcolor{keywordflow}{if} (ii != robjective) \{
00261         ar[glp\_index] = A[jj + ii * ncols];
00262         glp\_index++;
00263       \}
00264     \}
00265   \}
00266 
00267   glp\_index = 0;
00268 
00269   \textcolor{keywordflow}{for} (ii = 1; ii < problem\_size; ++ii) \{
00270     \textcolor{keywordflow}{if} (((ii - 1) % lp\_ncols) == 0) \{
00271       glp\_index++;
00272     \}
00273     ia[ii] = glp\_index;
00274     ja[ii] = (ii - 1) % lp\_ncols + 1;
00275   \}
00276 
00277   glp\_load\_matrix (lp, matsize, ia, ja, ar);
00278 
00279 \textcolor{preprocessor}{  #if MTK\_DEBUG\_LEVEL > 0}
00280   sprintf(mps\_file\_name, \textcolor{stringliteral}{"LP\_MPS\_row\_%02d.mps"}, robjective);
00281   glp\_write\_mps(lp, GLP\_MPS\_FILE, \textcolor{keyword}{nullptr}, mps\_file\_name);
00282 \textcolor{preprocessor}{  #endif}
00283 
00285 
00286   glp\_simplex (lp, \textcolor{keyword}{nullptr});
00287 
00288   \textcolor{comment}{// Check status of the solution.}
00289 
00290   \textcolor{keywordflow}{if} (glp\_get\_status(lp) == GLP\_OPT) \{
00291 
00292     \textcolor{keywordflow}{for}(ii = 1; ii <= lp\_ncols; ++ii) \{
00293       err[ii - 1] = qq[ii - 1] - glp\_get\_col\_prim(lp,ii);
00294     \}
00295 
00296 \textcolor{preprocessor}{    #if MTK\_DEBUG\_LEVEL > 0}
00297     obj\_value = glp\_get\_obj\_val (lp);
00298     std::cout << std::setw(12) << \textcolor{stringliteral}{"CBS"} << std::setw(12) << \textcolor{stringliteral}{"CRS"} << std::endl;
00299     \textcolor{keywordflow}{for} (ii = 0; ii < lp\_ncols; ++ii) \{
00300       std::cout << \textcolor{stringliteral}{"q\_"} << ii + 1 << \textcolor{stringliteral}{" = "} << std::setw(12) <<
00301         glp\_get\_col\_prim(lp,ii + 1) << std::setw(12) << qq[ii] << std::endl;
00302     \}
00303     std::cout << \textcolor{stringliteral}{"Objective function value (row "} << robjective + 1 << \textcolor{stringliteral}{") = "} <<
00304       obj\_value << std::endl;
00305 \textcolor{preprocessor}{    #endif}
00306 
00307     \textcolor{keywordflow}{if} (copy) \{
00308       \textcolor{keywordflow}{for}(ii = 0; ii < lp\_ncols; ++ii) \{
00309         qq[ii] = glp\_get\_col\_prim(lp,ii + 1);
00310       \}
00311       \textcolor{comment}{// Preserve the bottom values of qq.}
00312     \}
00313 
00314     x1 = \hyperlink{classmtk_1_1BLASAdapter_ab92440888b730863244c5d9479c11aca}{mtk::BLASAdapter::RealNRM2}(err,lp\_ncols);
00315 
00316   \} \textcolor{keywordflow}{else} \{
00317     x1 = std::numeric\_limits<mtk::Real>::infinity();
00318   \}
00319 
00320   glp\_delete\_prob (lp);
00321   glp\_free\_env ();
00322 
00323   \textcolor{keyword}{delete} [] ia;
00324   \textcolor{keyword}{delete} [] ja;
00325   \textcolor{keyword}{delete} [] ar;
00326   \textcolor{keyword}{delete} [] objective;
00327   \textcolor{keyword}{delete} [] rhs;
00328   \textcolor{keyword}{delete} [] err;
00329 
00330   \textcolor{keywordflow}{return} x1;
00331 \}
\end{DoxyCode}
