\hypertarget{mtk__glpk__adapter_8cc}{\section{mtk\-\_\-glpk\-\_\-adapter.\-cc}
\label{mtk__glpk__adapter_8cc}\index{src/mtk\-\_\-glpk\-\_\-adapter.\-cc@{src/mtk\-\_\-glpk\-\_\-adapter.\-cc}}
}

\begin{DoxyCode}
00001 
00019 \textcolor{comment}{/*}
00020 \textcolor{comment}{Copyright (C) 2015, Computational Science Research Center, San Diego State}
00021 \textcolor{comment}{University. All rights reserved.}
00022 \textcolor{comment}{}
00023 \textcolor{comment}{Redistribution and use in source and binary forms, with or without modification,}
00024 \textcolor{comment}{are permitted provided that the following conditions are met:}
00025 \textcolor{comment}{}
00026 \textcolor{comment}{1. Modifications to source code should be reported to: esanchez@mail.sdsu.edu}
00027 \textcolor{comment}{and a copy of the modified files should be reported once modifications are}
00028 \textcolor{comment}{completed. Documentation related to said modifications should be included.}
00029 \textcolor{comment}{}
00030 \textcolor{comment}{2. Redistributions of source code must be done through direct}
00031 \textcolor{comment}{downloads from the project's GitHub page: http://www.csrc.sdsu.edu/mtk}
00032 \textcolor{comment}{}
00033 \textcolor{comment}{3. Redistributions of source code must retain the above copyright notice, this}
00034 \textcolor{comment}{list of conditions and the following disclaimer.}
00035 \textcolor{comment}{}
00036 \textcolor{comment}{4. Redistributions in binary form must reproduce the above copyright notice,}
00037 \textcolor{comment}{this list of conditions and the following disclaimer in the documentation and/or}
00038 \textcolor{comment}{other materials provided with the distribution.}
00039 \textcolor{comment}{}
00040 \textcolor{comment}{5. Usage of the binary form on proprietary applications shall require explicit}
00041 \textcolor{comment}{prior written permission from the the copyright holders.}
00042 \textcolor{comment}{}
00043 \textcolor{comment}{6. Neither the name of the copyright holder nor the names of its contributors}
00044 \textcolor{comment}{may be used to endorse or promote products derived from this software without}
00045 \textcolor{comment}{specific prior written permission.}
00046 \textcolor{comment}{}
00047 \textcolor{comment}{The copyright holders provide no reassurances that the source code provided does}
00048 \textcolor{comment}{not infringe any patent, copyright, or any other intellectual property rights of}
00049 \textcolor{comment}{third parties. The copyright holders disclaim any liability to any recipient for}
00050 \textcolor{comment}{claims brought against recipient by any third party for infringement of that}
00051 \textcolor{comment}{parties intellectual property rights.}
00052 \textcolor{comment}{}
00053 \textcolor{comment}{THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND}
00054 \textcolor{comment}{ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED}
00055 \textcolor{comment}{WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE}
00056 \textcolor{comment}{DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR}
00057 \textcolor{comment}{ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES}
00058 \textcolor{comment}{(INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;}
00059 \textcolor{comment}{LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON}
00060 \textcolor{comment}{ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT}
00061 \textcolor{comment}{(INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS}
00062 \textcolor{comment}{SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.}
00063 \textcolor{comment}{*/}
00064 
00065 \textcolor{preprocessor}{#include <cmath>}
00066 \textcolor{preprocessor}{#include <cstring>}
00067 
00068 \textcolor{preprocessor}{#include <iostream>}
00069 \textcolor{preprocessor}{#include <iomanip>}
00070 \textcolor{preprocessor}{#include <limits>}
00071 
00072 \textcolor{preprocessor}{#include "\hyperlink{mtk__roots_8h}{mtk\_roots.h}"}
00073 \textcolor{preprocessor}{#include "\hyperlink{mtk__blas__adapter_8h}{mtk\_blas\_adapter.h}"}
00074 \textcolor{preprocessor}{#include "\hyperlink{mtk__glpk__adapter_8h}{mtk\_glpk\_adapter.h}"}
00075 
\hypertarget{mtk__glpk__adapter_8cc_source_l00076}{}\hyperlink{classmtk_1_1GLPKAdapter_a834480aca83e3c0d09fdab7fdb7e8a3f}{00076} \hyperlink{group__c01-roots_gac080bbbf5cbb5502c9f00405f894857d}{mtk::Real} \hyperlink{classmtk_1_1GLPKAdapter_a834480aca83e3c0d09fdab7fdb7e8a3f}{mtk::GLPKAdapter::SolveSimplexAndCompare}(
      \hyperlink{group__c01-roots_gac080bbbf5cbb5502c9f00405f894857d}{mtk::Real} *A,
00077                                                    \textcolor{keywordtype}{int} nrows,
00078                                                    \textcolor{keywordtype}{int} ncols,
00079                                                    \textcolor{keywordtype}{int} kk,
00080                                                    \hyperlink{group__c01-roots_gac080bbbf5cbb5502c9f00405f894857d}{mtk::Real} *hh,
00081                                                    \hyperlink{group__c01-roots_gac080bbbf5cbb5502c9f00405f894857d}{mtk::Real} *qq,
00082                                                    \textcolor{keywordtype}{int} robjective,
00083                                                    \hyperlink{group__c01-roots_gac080bbbf5cbb5502c9f00405f894857d}{mtk::Real} mimetic\_threshold,
00084                                                    \textcolor{keywordtype}{int} copy) \{
00085 
00086 \textcolor{preprocessor}{  #if MTK\_DEBUG\_LEVEL > 0}
00087 \textcolor{preprocessor}{}  \textcolor{keywordtype}{char} mps\_file\_name[18]; \textcolor{comment}{// File name for the MPS files.}
00088 \textcolor{preprocessor}{  #endif}
00089 \textcolor{preprocessor}{}  \textcolor{keywordtype}{char} rname[5];          \textcolor{comment}{// Row name.}
00090   \textcolor{keywordtype}{char} cname[5];          \textcolor{comment}{// Column name.}
00091 
00092   glp\_prob *lp; \textcolor{comment}{// Linear programming problem.}
00093 
00094   \textcolor{keywordtype}{int} *ia;  \textcolor{comment}{// Array for the problem.}
00095   \textcolor{keywordtype}{int} *ja;  \textcolor{comment}{// Array for the problem.}
00096 
00097   \textcolor{keywordtype}{int} problem\_size; \textcolor{comment}{// Size of the problem.}
00098   \textcolor{keywordtype}{int} lp\_nrows;     \textcolor{comment}{// Number of rows.}
00099   \textcolor{keywordtype}{int} lp\_ncols;     \textcolor{comment}{// Number of columns.}
00100   \textcolor{keywordtype}{int} matsize;      \textcolor{comment}{// Size of the matrix.}
00101   \textcolor{keywordtype}{int} glp\_index\{1\}; \textcolor{comment}{// Index of the objective function.}
00102   \textcolor{keywordtype}{int} ii;           \textcolor{comment}{// Iterator.}
00103   \textcolor{keywordtype}{int} jj;           \textcolor{comment}{// Iterator.}
00104 
00105   \hyperlink{group__c01-roots_gac080bbbf5cbb5502c9f00405f894857d}{mtk::Real} *ar;            \textcolor{comment}{// Array for the problem.}
00106   \hyperlink{group__c01-roots_gac080bbbf5cbb5502c9f00405f894857d}{mtk::Real} *objective;     \textcolor{comment}{// Array containing the objective function.}
00107   \hyperlink{group__c01-roots_gac080bbbf5cbb5502c9f00405f894857d}{mtk::Real} *rhs;           \textcolor{comment}{// Array containing the rhs.}
00108   \hyperlink{group__c01-roots_gac080bbbf5cbb5502c9f00405f894857d}{mtk::Real} *err;           \textcolor{comment}{// Array of errors.}
00109 
00110   \hyperlink{group__c01-roots_gac080bbbf5cbb5502c9f00405f894857d}{mtk::Real} x1;             \textcolor{comment}{// Norm-2 of the error.}
00111 
00112 \textcolor{preprocessor}{  #if MTK\_DEBUG\_LEVEL > 0}
00113 \textcolor{preprocessor}{}  \hyperlink{group__c01-roots_gac080bbbf5cbb5502c9f00405f894857d}{mtk::Real} obj\_value;      \textcolor{comment}{// Value of the objective function.}
00114 \textcolor{preprocessor}{  #endif}
00115 \textcolor{preprocessor}{}
00116   lp\_nrows = kk;
00117   lp\_ncols = kk;
00118 
00119   matsize = lp\_nrows*lp\_ncols;
00120 
00122 
00124   problem\_size = lp\_nrows*lp\_ncols + 1;
00125 
00126   \textcolor{keywordflow}{try} \{
00127     ia = \textcolor{keyword}{new} \textcolor{keywordtype}{int}[problem\_size];
00128   \} \textcolor{keywordflow}{catch} (std::bad\_alloc &memory\_allocation\_exception) \{
00129     std::cerr << \textcolor{stringliteral}{"Memory allocation exception on line "} << \_\_LINE\_\_ - 3 <<
00130       std::endl;
00131     std::cerr << memory\_allocation\_exception.what() << std::endl;
00132   \}
00133   memset(ia, 0, \textcolor{keyword}{sizeof}(ia[0])*problem\_size);
00134 
00135   \textcolor{keywordflow}{try} \{
00136     ja = \textcolor{keyword}{new} \textcolor{keywordtype}{int}[problem\_size];
00137   \} \textcolor{keywordflow}{catch} (std::bad\_alloc &memory\_allocation\_exception) \{
00138     std::cerr << \textcolor{stringliteral}{"Memory allocation exception on line "} << \_\_LINE\_\_ - 3 <<
00139       std::endl;
00140     std::cerr << memory\_allocation\_exception.what() << std::endl;
00141   \}
00142   memset(ja, 0, \textcolor{keyword}{sizeof}(ja[0])*problem\_size);
00143 
00144   \textcolor{keywordflow}{try} \{
00145     ar = \textcolor{keyword}{new} \hyperlink{group__c01-roots_gac080bbbf5cbb5502c9f00405f894857d}{mtk::Real}[problem\_size];
00146   \} \textcolor{keywordflow}{catch} (std::bad\_alloc &memory\_allocation\_exception) \{
00147     std::cerr << \textcolor{stringliteral}{"Memory allocation exception on line "} << \_\_LINE\_\_ - 3 <<
00148       std::endl;
00149     std::cerr << memory\_allocation\_exception.what() << std::endl;
00150   \}
00151   memset(ar, \hyperlink{group__c01-roots_ga59a451a5fae30d59649bcda274fea271}{mtk::kZero}, \textcolor{keyword}{sizeof}(ar[0])*problem\_size);
00152 
00153   \textcolor{keywordflow}{try} \{
00154     objective = \textcolor{keyword}{new} \hyperlink{group__c01-roots_gac080bbbf5cbb5502c9f00405f894857d}{mtk::Real}[lp\_ncols + 1];
00155   \} \textcolor{keywordflow}{catch} (std::bad\_alloc &memory\_allocation\_exception) \{
00156     std::cerr << \textcolor{stringliteral}{"Memory allocation exception on line "} << \_\_LINE\_\_ - 3 <<
00157       std::endl;
00158     std::cerr << memory\_allocation\_exception.what() << std::endl;
00159   \}
00160   memset(objective, \hyperlink{group__c01-roots_ga59a451a5fae30d59649bcda274fea271}{mtk::kZero}, \textcolor{keyword}{sizeof}(objective[0])*(lp\_ncols + 1));
00161 
00162   \textcolor{keywordflow}{try} \{
00163     rhs = \textcolor{keyword}{new} \hyperlink{group__c01-roots_gac080bbbf5cbb5502c9f00405f894857d}{mtk::Real}[lp\_nrows + 1];
00164   \} \textcolor{keywordflow}{catch} (std::bad\_alloc &memory\_allocation\_exception) \{
00165     std::cerr << \textcolor{stringliteral}{"Memory allocation exception on line "} << \_\_LINE\_\_ - 3 <<
00166       std::endl;
00167     std::cerr << memory\_allocation\_exception.what() << std::endl;
00168   \}
00169   memset(rhs, \hyperlink{group__c01-roots_ga59a451a5fae30d59649bcda274fea271}{mtk::kZero}, \textcolor{keyword}{sizeof}(rhs[0])*(lp\_nrows + 1));
00170 
00171   \textcolor{keywordflow}{try} \{
00172     err = \textcolor{keyword}{new} \hyperlink{group__c01-roots_gac080bbbf5cbb5502c9f00405f894857d}{mtk::Real}[lp\_nrows];
00173   \} \textcolor{keywordflow}{catch} (std::bad\_alloc &memory\_allocation\_exception) \{
00174     std::cerr << \textcolor{stringliteral}{"Memory allocation exception on line "} << \_\_LINE\_\_ - 3 <<
00175       std::endl;
00176     std::cerr << memory\_allocation\_exception.what() << std::endl;
00177   \}
00178   memset(err, \hyperlink{group__c01-roots_ga59a451a5fae30d59649bcda274fea271}{mtk::kZero}, \textcolor{keyword}{sizeof}(err[0])*(lp\_nrows));
00179 
00180 \textcolor{preprocessor}{  #if MTK\_DEBUG\_LEVEL > 0}
00181 \textcolor{preprocessor}{}  std::cout << \textcolor{stringliteral}{"Problem size: "} << problem\_size << std::endl;
00182   std::cout << \textcolor{stringliteral}{"lp\_nrows = "} << lp\_nrows << std::endl;
00183   std::cout << \textcolor{stringliteral}{"lp\_ncols = "} << lp\_ncols << std::endl;
00184   std::cout << std::endl;
00185 \textcolor{preprocessor}{  #endif}
00186 \textcolor{preprocessor}{}
00187   lp = glp\_create\_prob();
00188 
00189   glp\_set\_prob\_name (lp, \textcolor{stringliteral}{"mtk::GLPKAdapter::Simplex"});
00190 
00191   glp\_set\_obj\_dir (lp, GLP\_MIN);
00192 
00194 
00195   glp\_add\_rows(lp, lp\_nrows);
00196 
00197   \textcolor{keywordflow}{for} (ii = 1; ii <= lp\_nrows; ++ii) \{
00198     sprintf(rname, \textcolor{stringliteral}{"R%02d"},ii);
00199     glp\_set\_row\_name(lp, ii, rname);
00200   \}
00201 
00202   glp\_add\_cols(lp, lp\_ncols);
00203 
00204   \textcolor{keywordflow}{for} (ii = 1; ii <= lp\_ncols; ++ii) \{
00205     sprintf(cname, \textcolor{stringliteral}{"Q%02d"},ii);
00206     glp\_set\_col\_name (lp, ii, cname);
00207   \}
00208 
00210 
00211 \textcolor{preprocessor}{  #if MTK\_DEBUG\_LEVEL>0}
00212 \textcolor{preprocessor}{}  std::cout << \textcolor{stringliteral}{"Using row "} << robjective + 1 << \textcolor{stringliteral}{" as objective."} << std::endl;
00213 \textcolor{preprocessor}{  #endif}
00214 \textcolor{preprocessor}{}  \textcolor{keywordflow}{for} (jj = 0; jj < kk; ++jj) \{
00215     objective[glp\_index] = A[jj + robjective * ncols];
00216     glp\_index++;
00217   \}
00218 \textcolor{preprocessor}{  #if MTK\_DEBUG\_LEVEL >0}
00219 \textcolor{preprocessor}{}  std::cout << std::endl;
00220 \textcolor{preprocessor}{  #endif}
00221 \textcolor{preprocessor}{}
00223 
00224   glp\_index = 1;
00225   rhs[0] = \hyperlink{group__c01-roots_ga59a451a5fae30d59649bcda274fea271}{mtk::kZero};
00226   \textcolor{keywordflow}{for} (ii = 0; ii <= lp\_nrows; ++ii) \{
00227     \textcolor{keywordflow}{if} (ii != robjective) \{
00228       rhs[glp\_index] = hh[ii];
00229       glp\_set\_row\_bnds(lp, glp\_index, GLP\_UP, 0.0, rhs[glp\_index]);
00230       glp\_index++;
00231     \}
00232   \}
00233 
00234 \textcolor{preprocessor}{  #if MTK\_DEBUG\_LEVEL > 0}
00235 \textcolor{preprocessor}{}  std::cout << \textcolor{stringliteral}{"rhs ="} << std::endl;
00236   \textcolor{keywordflow}{for} (\textcolor{keyword}{auto} ii = 0; ii < lp\_nrows; ++ii) \{
00237     std::cout << std::setw(15) << rhs[ii] << std::endl;
00238   \}
00239   std::cout << std::endl;
00240 \textcolor{preprocessor}{  #endif}
00241 \textcolor{preprocessor}{}
00243 
00244   \textcolor{keywordflow}{for} (ii = 1; ii <= lp\_ncols; ++ii) \{
00245     glp\_set\_obj\_coef (lp, ii, objective[ii]);
00246   \}
00247 
00249 
00250   \textcolor{keywordflow}{for} (ii = 1; ii <= lp\_ncols; ++ii) \{
00251     glp\_set\_col\_bnds (lp, ii, GLP\_LO, mimetic\_threshold, 0.0);
00252   \}
00253 
00255 
00256   glp\_index = 1;
00257   \textcolor{keywordflow}{for} (ii = 0; ii <= kk; ++ii) \{
00258     \textcolor{keywordflow}{for} (jj = 0; jj < kk; ++jj) \{
00259       \textcolor{keywordflow}{if} (ii != robjective) \{
00260         ar[glp\_index] = A[jj + ii * ncols];
00261         glp\_index++;
00262       \}
00263     \}
00264   \}
00265 
00266   glp\_index = 0;
00267 
00268   \textcolor{keywordflow}{for} (ii = 1; ii < problem\_size; ++ii) \{
00269     \textcolor{keywordflow}{if} (((ii - 1) % lp\_ncols) == 0) \{
00270       glp\_index++;
00271     \}
00272     ia[ii] = glp\_index;
00273     ja[ii] = (ii - 1) % lp\_ncols + 1;
00274   \}
00275 
00276   glp\_load\_matrix (lp, matsize, ia, ja, ar);
00277 
00278 \textcolor{preprocessor}{  #if MTK\_DEBUG\_LEVEL > 0}
00279 \textcolor{preprocessor}{}  sprintf(mps\_file\_name, \textcolor{stringliteral}{"LP\_MPS\_row\_%02d.mps"}, robjective);
00280   glp\_write\_mps(lp, GLP\_MPS\_FILE, \textcolor{keyword}{nullptr}, mps\_file\_name);
00281 \textcolor{preprocessor}{  #endif}
00282 \textcolor{preprocessor}{}
00284 
00285   glp\_simplex (lp, \textcolor{keyword}{nullptr});
00286 
00287   \textcolor{comment}{// Check status of the solution.}
00288 
00289   \textcolor{keywordflow}{if} (glp\_get\_status(lp) == GLP\_OPT) \{
00290 
00291     \textcolor{keywordflow}{for}(ii = 1; ii <= lp\_ncols; ++ii) \{
00292       err[ii - 1] = qq[ii - 1] - glp\_get\_col\_prim(lp,ii);
00293     \}
00294 
00295 \textcolor{preprocessor}{    #if MTK\_DEBUG\_LEVEL > 0}
00296 \textcolor{preprocessor}{}    obj\_value = glp\_get\_obj\_val (lp);
00297     std::cout << std::setw(12) << \textcolor{stringliteral}{"CBS"} << std::setw(12) << \textcolor{stringliteral}{"CRS"} << std::endl;
00298     \textcolor{keywordflow}{for} (ii = 0; ii < lp\_ncols; ++ii) \{
00299       std::cout << \textcolor{stringliteral}{"q\_"} << ii + 1 << \textcolor{stringliteral}{" = "} << std::setw(12) <<
00300         glp\_get\_col\_prim(lp,ii + 1) << std::setw(12) << qq[ii] << std::endl;
00301     \}
00302     std::cout << \textcolor{stringliteral}{"Objective function value (row "} << robjective + 1 << \textcolor{stringliteral}{") = "} <<
00303       obj\_value << std::endl;
00304 \textcolor{preprocessor}{    #endif}
00305 \textcolor{preprocessor}{}
00306     \textcolor{keywordflow}{if} (copy) \{
00307       \textcolor{keywordflow}{for}(ii = 0; ii < lp\_ncols; ++ii) \{
00308         qq[ii] = glp\_get\_col\_prim(lp,ii + 1);
00309       \}
00310       \textcolor{comment}{// Preserve the bottom values of qq.}
00311     \}
00312 
00313     x1 = \hyperlink{classmtk_1_1BLASAdapter_ab92440888b730863244c5d9479c11aca}{mtk::BLASAdapter::RealNRM2}(err,lp\_ncols);
00314 
00315   \} \textcolor{keywordflow}{else} \{
00316     x1 = std::numeric\_limits<mtk::Real>::infinity();
00317   \}
00318 
00319   glp\_delete\_prob (lp);
00320   glp\_free\_env ();
00321 
00322   \textcolor{keyword}{delete} [] ia;
00323   \textcolor{keyword}{delete} [] ja;
00324   \textcolor{keyword}{delete} [] ar;
00325   \textcolor{keyword}{delete} [] objective;
00326   \textcolor{keyword}{delete} [] rhs;
00327   \textcolor{keyword}{delete} [] err;
00328 
00329   \textcolor{keywordflow}{return} x1;
00330 \}
\end{DoxyCode}
